#!/usr/bin/env nu

open input | { stacks: ($in | str substring [0 ($in | str index-of "\n\n")] | str replace -a '\[(\w)\] ?' '$1,' | str replace -a '    ' ';,' | str replace -a ' ' '' | split row "\n" | split column -c ',' | drop 1 | transpose -i | each { |i,j| transpose key value | where value != ';' | get value | reverse } ), commands: ($in | str substring [($in | str index-of "\n\n") -1] | str replace -a 'move ' '' | str replace -a ' from ' ',' | str replace -a ' to ' ',' | $"num,src,dst\n($in)" | from csv) } | each { |i| $i.commands | reduce -f $i.stacks { |j, acc| (seq 1 $j.num) | reduce -f $acc { |k, acc2| $acc2 | each { |s, n| if ($n + 1) == $j.src { $s | drop } else if ($n + 1) == $j.dst { $s | append ($acc2 | get ($j.src - 1) | last) } else { $s } } } } } | each { |i| $i | last } | str join
